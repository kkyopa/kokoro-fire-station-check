<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>ã“ã“ã‚ã®å®šæœŸæ¤œè¨º</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    /* CSSã¯ãã®ã¾ã¾ */
    body { background-color: #fffaf0; font-family: 'Hiragino Maru Gothic ProN', sans-serif; color: #5d4037; }
    .container { max-width: 500px; padding: 30px 20px; }
    .card { border-radius: 20px; border: none; box-shadow: 0 8px 20px rgba(139, 69, 19, 0.08); margin-bottom: 24px; padding: 24px; background: white; }
    .question-block { margin-bottom: 2.5rem; }
    .q-label { font-weight: 600; margin-bottom: 12px; display: block; color: #5d4037; }
    .btn-step { flex: 1; border: 1px solid #edc7b7; background: #fff; border-radius: 12px; padding: 10px 0; color: #8d6e63; }
    .btn-step.active { background-color: #ff7f50; color: white; border-color: #ff7f50; }
    .btn-group-step { display: flex; justify-content: space-between; gap: 6px; }
    .btn-submit { background: linear-gradient(135deg, #ff7f50, #ff6b6b); border: none; border-radius: 50px; padding: 16px; font-weight: bold; color: white; width: 100%; }
    .btn-submit:disabled { background: #e0e0e0; }
    .result-box { background: #fff5ee; padding: 24px; border-radius: 16px; border-left: 6px solid #ff7f50; margin-bottom: 20px; }
    #login-card { text-align: center; padding: 40px 20px; }
    .btn-login { background-color: #06C755; color: white; font-weight: bold; padding: 12px 30px; border-radius: 30px; border: none; }
  </style>
</head>
<body>
  <div class="container text-center">
    <h4 style="color: #8b4513; font-weight: bold;">ğŸš’ ã“ã“ã‚ã®å®šæœŸæ¤œè¨º</h4>
    <p style="color: #a1887f; font-size: 0.9rem; margin-bottom: 2rem;">æœ€è¿‘èª¿å­ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿ</p>
    
    <div id="login-card" class="card" style="display:none;">
      <h5 class="mb-3">åˆ©ç”¨ã‚’é–‹å§‹ã™ã‚‹</h5>
      <p class="small text-muted mb-4">è¨˜éŒ²ã®ãŸã‚ã«LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
      <button class="btn btn-login" onclick="liff.login()">LINEã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="quiz-card" class="card" style="display:none;">
      <div id="k6-questions">
        <div class="question-block" data-q="0"><label class="q-label text-start">1. ç¥çµŒéæ•ã«æ„Ÿã˜ã¾ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
        <div class="question-block" data-q="1"><label class="q-label text-start">2. çµ¶æœ›çš„ã ã¨æ„Ÿã˜ã¾ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
        <div class="question-block" data-q="2"><label class="q-label text-start">3. ãã‚ãã‚è½ã¡ç€ãã¾ã›ã‚“ã§ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
        <div class="question-block" data-q="3"><label class="q-label text-start">4. æ°—åˆ†ãŒæ²ˆã¿è¾¼ã‚“ã§ã„ã¾ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
        <div class="question-block" data-q="4"><label class="q-label text-start">5. ä½•ã‚’ã™ã‚‹ã®ã‚‚å„„åŠ«ã§ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
        <div class="question-block" data-q="5"><label class="q-label text-start">6. è‡ªåˆ†ã¯ä¾¡å€¤ãŒãªã„ã¨æ„Ÿã˜ã¾ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
      </div>
      <button id="submit-btn" class="btn btn-submit mt-4" onclick="submitDiagnosis()" disabled>ç‚¹æ¤œã™ã‚‹</button>
    </div>

    <div id="loading" class="mt-5" style="display:none;">
      <div class="spinner-border text-danger" role="status" style="width: 3rem; height: 3rem;"></div>
      <p class="mt-3" style="color: #8b4513;">AIãŒè§£æä¸­...<br>ã‚†ã£ãã‚ŠãŠå¾…ã¡ãã ã•ã„ã€‚</p>
    </div>
    
    <div id="result" class="card mt-3" style="display:none;">
      <div style="background:#8b4513;color:white;padding:4px 15px;border-radius:20px;display:inline-block;margin-bottom:15px;font-size:0.8rem;">è¨ºæ–­çµæœ</div>
      <h5 class="fw-bold mb-4" style="color: #8b4513;">ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«: <span id="result-level" style="font-size:1.4em; color:#ff6b6b;"></span></h5>
      <div class="result-box text-start">
        <span style="font-size:1.5rem;display:block;margin-bottom:10px;">ğŸ€</span>
        <p id="ai-message" style="line-height:1.8;font-size:0.95rem;color:#5d4037;white-space:pre-wrap;"></p>
      </div>
      <div class="d-grid gap-2 mt-4">
        <button class="btn btn-outline-secondary rounded-pill py-2" onclick="liff.closeWindow()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

<script>
  // â˜…é‡è¦è¨­å®šâ˜…
  const LIFF_ID = 'ã‚ãªãŸã®LIFF_ID'; 
  const GAS_API_URL = 'https://script.google.com/macros/s/xxxx/exec'; // â˜…GASã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’ã“ã“ã«è²¼ã‚‹

  let k6Answers = [null, null, null, null, null, null];
  let currentUser = null;

  window.onload = function() {
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (liff.isLoggedIn()) {
        liff.getProfile().then(profile => {
          currentUser = profile;
          document.getElementById('login-card').style.display = 'none';
          document.getElementById('quiz-card').style.display = 'block';
        });
      } else {
        document.getElementById('login-card').style.display = 'block';
      }
    });
  };

  // å›ç­”ãƒœã‚¿ãƒ³å‡¦ç†
  document.querySelectorAll('.btn-step').forEach(button => {
    button.addEventListener('click', function() {
      const parent = this.closest('.question-block');
      const qIndex = parent.getAttribute('data-q');
      parent.querySelectorAll('.btn-step').forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      k6Answers[qIndex] = parseInt(this.getAttribute('data-val'));
      const isK6Ok = !k6Answers.includes(null);
      document.getElementById('submit-btn').disabled = !isK6Ok;
    });
  });

  // â–  ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šGASã¸ã®é€ä¿¡ã‚’ fetch ã§è¡Œã†
  function submitDiagnosis() {
    document.getElementById('quiz-card').style.display = 'none';
    document.getElementById('loading').style.display = 'block';

    const payload = {
      k6Answers: k6Answers,
      userInfo: currentUser ? { userId: currentUser.userId, displayName: currentUser.displayName } : { userId: 'anonymous' }
    };

    // fetchã‚’ä½¿ã£ã¦GASã«ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•ã’ã‚‹
    fetch(GAS_API_URL, {
      method: 'POST',
      mode: 'no-cors', // â˜…é‡è¦ï¼šGASã¸ã®POSTã¯no-corsã§è¡Œã†
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(() => {
      // no-corsãªã®ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¸­èº«ã¯è¦‹ã‚Œãªã„ãŒã€GASå´ã§å‡¦ç†ã¯èµ°ã‚‹
      // æˆåŠŸã¨ã¿ãªã—ã¦çµæœç”»é¢ã¸ï¼ˆâ€»å³å¯†ã«ã¯AIã®æ–‡ç« ã‚’å—ã‘å–ã‚Œãªã„ã®ã§ã€ä»Šå›ã¯ãƒ€ãƒŸãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã€redirectãƒãƒƒã‚¯ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€MVPãªã‚‰ä¸‹è¨˜ã®æ–¹æ³•ãŒä¸€ç•ªå®‰å®šã—ã¾ã™ï¼‰
      
      // â˜…æ³¨æ„ï¼šGitHubPagesã‹ã‚‰GASã¸ã®é€šä¿¡ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™(CORS)ãŒå³ã—ã„ã§ã™ã€‚
      // ä»Šå›ã¯ãƒ”ãƒƒãƒç”¨MVPãªã®ã§ã€ç°¡æ˜“çš„ã«ã€Œé€ä¿¡å®Œäº†ã€ã‚’è¡¨ç¤ºã—ã€AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯GASã‹ã‚‰LINEã«é€ã‚‹ã‹ã€
      // ä»¥ä¸‹ã®è£æŠ€ï¼ˆredirectãƒãƒƒã‚¯ï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚
      
      // è£æŠ€ã‚’ä½¿ã‚ãªã„å ´åˆï¼š
      // alert("è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸï¼çµæœã¯é€šçŸ¥ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ï¼ˆæœ¬æ¥ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰");
      // liff.closeWindow();
      
      // â€»AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«å‡ºã—ãŸã„å ´åˆã¯ã€å°‘ã—è¤‡é›‘ãªé€šä¿¡ãŒå¿…è¦ã§ã™ã€‚
      // ã„ã£ãŸã‚“ã€Œé€ä¿¡ã¯æˆåŠŸã™ã‚‹ã€ã¨ã“ã‚ã¾ã§ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
    })
    .catch(err => {
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('quiz-card').style.display = 'block';
    });
  }
  
  // â˜…ç‰¹è¨˜äº‹é …
  // GitHub Pagesã‹ã‚‰GASã®AIè¿”ç­”ã‚’å—ã‘å–ã‚‹ã«ã¯ã€ŒCORSã€ã¨ã„ã†å£ãŒã‚ã‚Šã¾ã™ã€‚
  // ä¸€ç•ªç°¡å˜ãªã®ã¯ã€ã€ŒsubmitDiagnosisã€ã®ä¸­ã§fetchã—ãŸã‚ã¨ã€
  // ã€ŒçµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§æ•°ç§’å¾…ã£ã¦ã­ã€ã¨ã—ã¦ã€çµæœã‚’ã“ã“ã«å‡ºã™ã®ã§ã¯ãªãã€
  // GASå´ã‹ã‚‰ã€ŒreplyMessageã€ã§LINEã«çµæœã‚’é€ã£ã¦ã—ã¾ã†ã“ã¨ã§ã™ã€‚
  // ãã‚Œãªã‚‰CORSã‚’ç„¡è¦–ã§ãã¾ã™ã€‚
</script>
</body>
</html>
