<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>ã“ã“ã‚ã®å®šæœŸæ¤œè¨º</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    /* CSSã¯ãã®ã¾ã¾ */
    body { background-color: #fffaf0; font-family: 'Hiragino Maru Gothic ProN', sans-serif; color: #5d4037; }
    .container { max-width: 500px; padding: 30px 20px; }
    .card { border-radius: 20px; border: none; box-shadow: 0 8px 20px rgba(139, 69, 19, 0.08); margin-bottom: 24px; padding: 24px; background: white; }
    .question-block { margin-bottom: 2.5rem; }
    .q-label { font-weight: 600; margin-bottom: 12px; display: block; color: #5d4037; }
    .btn-step { flex: 1; border: 1px solid #edc7b7; background: #fff; border-radius: 12px; padding: 10px 0; color: #8d6e63; }
    .btn-step.active { background-color: #ff7f50; color: white; border-color: #ff7f50; }
    .btn-group-step { display: flex; justify-content: space-between; gap: 6px; }
    .btn-submit { background: linear-gradient(135deg, #ff7f50, #ff6b6b); border: none; border-radius: 50px; padding: 16px; font-weight: bold; color: white; width: 100%; }
    .btn-submit:disabled { background: #e0e0e0; }
    .result-box { background: #fff5ee; padding: 24px; border-radius: 16px; border-left: 6px solid #ff7f50; margin-bottom: 20px; }
    #login-card { text-align: center; padding: 40px 20px; }
    .btn-login { background-color: #06C755; color: white; font-weight: bold; padding: 12px 30px; border-radius: 30px; border: none; }
  </style>
</head>
<body>
  <div class="container text-center">
    <h4 style="color: #8b4513; font-weight: bold;">ğŸš’ ã“ã“ã‚ã®å®šæœŸæ¤œè¨º</h4>
    <p style="color: #a1887f; font-size: 0.9rem; margin-bottom: 2rem;">æœ€è¿‘èª¿å­ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿ</p>
    
    <div id="login-card" class="card" style="display:none;">
      <h5 class="mb-3">åˆ©ç”¨ã‚’é–‹å§‹ã™ã‚‹</h5>
      <p class="small text-muted mb-4">è¨˜éŒ²ã®ãŸã‚ã«LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
      <button class="btn btn-login" onclick="liff.login()">LINEã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="quiz-card" class="card" style="display:none;">
      <div id="k6-questions">
        <div class="question-block" data-q="0"><label class="q-label text-start">1. ç¥çµŒéæ•ã«æ„Ÿã˜ã¾ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
        <div class="question-block" data-q="1"><label class="q-label text-start">2. çµ¶æœ›çš„ã ã¨æ„Ÿã˜ã¾ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
        <div class="question-block" data-q="2"><label class="q-label text-start">3. ãã‚ãã‚è½ã¡ç€ãã¾ã›ã‚“ã§ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
        <div class="question-block" data-q="3"><label class="q-label text-start">4. æ°—åˆ†ãŒæ²ˆã¿è¾¼ã‚“ã§ã„ã¾ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
        <div class="question-block" data-q="4"><label class="q-label text-start">5. ä½•ã‚’ã™ã‚‹ã®ã‚‚å„„åŠ«ã§ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
        <div class="question-block" data-q="5"><label class="q-label text-start">6. è‡ªåˆ†ã¯ä¾¡å€¤ãŒãªã„ã¨æ„Ÿã˜ã¾ã—ãŸã‹ï¼Ÿ</label><div class="btn-group-step"><button class="btn-step" data-val="0">ãªã„</button><button class="btn-step" data-val="1">å°‘ã—</button><button class="btn-step" data-val="2">æ™‚ã€…</button><button class="btn-step" data-val="3">å¤§æŠµ</button><button class="btn-step" data-val="4">å¸¸æ™‚</button></div></div>
      </div>
      <button id="submit-btn" class="btn btn-submit mt-4" onclick="submitDiagnosis()" disabled>ç‚¹æ¤œã™ã‚‹</button>
    </div>

    <div id="loading" class="mt-5" style="display:none;">
      <div class="spinner-border text-danger" role="status" style="width: 3rem; height: 3rem;"></div>
      <p class="mt-3" style="color: #8b4513;">AIãŒè§£æä¸­...<br>ã‚†ã£ãã‚ŠãŠå¾…ã¡ãã ã•ã„ã€‚</p>
    </div>
    
    <div id="result" class="card mt-3" style="display:none;">
      <div style="background:#8b4513;color:white;padding:4px 15px;border-radius:20px;display:inline-block;margin-bottom:15px;font-size:0.8rem;">è¨ºæ–­çµæœ</div>
      <div class="result-box text-start">
        <p id="ai-message" style="line-height:1.8;font-size:0.95rem;color:#5d4037;white-space:pre-wrap;"></p>
      </div>
      <div class="d-grid gap-2 mt-4">
        <button class="btn btn-outline-secondary rounded-pill py-2" onclick="handleClose()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

<script>
  const LIFF_ID = '2008830983-NPJMV63i'; 
  const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyHbAqULrREil7IvKxUWJTHDBYxJUaUw7PNIi8_0Gf6Apox1-A9hdzUIAF5v08pGvg/exec';

  let k6Answers = [null, null, null, null, null, null];
  let currentUser = null;

  window.onload = function() {
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (liff.isLoggedIn()) {
        liff.getProfile().then(profile => {
          currentUser = profile;
          document.getElementById('login-card').style.display = 'none';
          document.getElementById('quiz-card').style.display = 'block';
        });
      } else {
        document.getElementById('login-card').style.display = 'block';
      }
    });
  };

  // å›ç­”ãƒœã‚¿ãƒ³å‡¦ç†
  document.querySelectorAll('.btn-step').forEach(button => {
    button.addEventListener('click', function() {
      const parent = this.closest('.question-block');
      const qIndex = parent.getAttribute('data-q');
      parent.querySelectorAll('.btn-step').forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      k6Answers[qIndex] = parseInt(this.getAttribute('data-val'));
      const isK6Ok = !k6Answers.includes(null);
      document.getElementById('submit-btn').disabled = !isK6Ok;
    });
  });


function handleClose() {
  // LINEã‚¢ãƒ—ãƒªå†…ã§é–‹ã„ã¦ã„ã‚‹å ´åˆ
  if (liff.isInClient()) {
    liff.closeWindow();
  } 
  // ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆPCãªã©ï¼‰ã§é–‹ã„ã¦ã„ã‚‹å ´åˆ
  else {
    alert("LINEã‚¢ãƒ—ãƒªå†…ã§ã‚ã‚Œã°ã€ã“ã“ã§ç”»é¢ãŒé–‰ã˜ã¾ã™ã€‚\n(ç¾åœ¨ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãŸã‚é–‰ã˜ã‚‰ã‚Œã¾ã›ã‚“)");
    // ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã‚ˆã†ã¨è©¦ã¿ã‚‹ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€åŠ¹ã‹ãªã„ã“ã¨ãŒå¤šã„ã§ã™ãŒä¸€å¿œè¨˜è¿°ï¼‰
    window.close();
  }
}

function submitDiagnosis() {
  // 1. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’å‡ºã™
  document.getElementById('quiz-card').style.display = 'none';
  document.getElementById('loading').style.display = 'block';

  const payload = {
    k6Answers: k6Answers,
    userInfo: currentUser ? { userId: currentUser.userId, displayName: currentUser.displayName } : { userId: 'anonymous' }
  };

  // 2. GASã«ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•ã’ã‚‹ï¼ˆè¿”äº‹ã¯å¾…ãŸãªã„ï¼ï¼‰
  // .then() ã‚„ .catch() ã¯æ›¸ã‹ãšã«ã€æŠ•ã’ã£ã±ãªã—ã«ã—ã¾ã™
  fetch(GAS_API_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  // 3. â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼
  // é€šä¿¡ã®çµæœã«é–¢ä¿‚ãªãã€2.5ç§’å¾Œã«å¼·åˆ¶çš„ã«ã€Œå®Œäº†ç”»é¢ã€ã¸é£›ã°ã™
  setTimeout(function() {
    showCompleteScreen();
  }, 2500);
}

// å®Œäº†ç”»é¢ã®è¡¨ç¤º
function showCompleteScreen() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('result').style.display = 'block';
  
  // ç”»é¢ã®æ–‡è¨€
  document.getElementById('ai-message').innerText = "è¨ºæ–­çµæœã‚’LINEã«é€ä¿¡ã—ã¾ã—ãŸğŸ“©\nãƒˆãƒ¼ã‚¯ç”»é¢ã«æˆ»ã£ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
  document.getElementById('result-level').innerText = "é€ä¿¡å®Œäº†";
}
</script>
</body>
</html>
